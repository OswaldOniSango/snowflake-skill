name: Deploy Skill (Pages)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required files
        run: |
          set -euo pipefail

          if [ ! -f "SKILL.md" ]; then
            echo "ERROR: SKILL.md not found at repo root."
            echo "Move SKILL.md to the repository root so skills can install it."
            exit 1
          fi

          echo "OK: SKILL.md exists."

          # Optional: check referenced docs exist (best-effort)
          # This scans the 'Reference docs' list and verifies files exist.
          python3 - << 'PY'
          import re, pathlib, sys
          p = pathlib.Path("SKILL.md")
          txt = p.read_text(encoding="utf-8")
          # find list items like "- foo.md"
          items = re.findall(r'^\s*-\s+([A-Za-z0-9_.\-/]+)\s*$', txt, flags=re.M)
          missing = []
          for it in items:
            # only check local markdown/docs/templates, skip placeholders or external stuff
            path = pathlib.Path(it)
            if path.suffix in {".md", ".sql", ".yml", ".yaml"} and not path.exists():
              missing.append(it)
          if missing:
            print("WARNING: Some referenced files are missing:")
            for m in missing:
              print(" -", m)
            # don't fail hard; flip to sys.exit(1) if you want strict behavior
          else:
            print("OK: referenced local files look present (best-effort).")
          PY

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v5

      # We publish the repo contents as static files (SKILL.md + docs + templates)
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
