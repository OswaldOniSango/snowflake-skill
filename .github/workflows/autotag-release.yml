name: Auto Tag + Release (multi-skill)

on:
  push:
    branches: ["prod"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  autotag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Tag and release each skill with a new version
        run: |
          set -euo pipefail

          python3 - << 'PYEOF'
          import re, pathlib, subprocess, sys

          for skill_md in sorted(pathlib.Path("skills").glob("*/SKILL.md")):
              spath = skill_md.parent
              name = spath.name

              txt = skill_md.read_text(encoding="utf-8")
              m = re.search(r'(?m)^\s*version:\s*([0-9]+(?:\.[0-9]+){1,3})\s*$', txt)
              if not m:
                  print(f"[{name}] No version found in SKILL.md – skipping")
                  continue

              version = m.group(1)
              tag = f"{name}-v{version}"

              # Check if tag already exists
              result = subprocess.run(
                  ["git", "rev-parse", tag],
                  capture_output=True, text=True
              )
              if result.returncode == 0:
                  print(f"[{name}] Tag {tag} already exists – skipping")
                  continue

              print(f"[{name}] Creating tag {tag} ...")
              subprocess.run(["git", "tag", tag], check=True)
              subprocess.run(["git", "push", "origin", tag], check=True)
              print(f"[{name}] Tag {tag} pushed.")

              # Write tag to file so the release step can pick it up
              pathlib.Path("/tmp/new_tags.txt").open("a").write(
                  f"{name}|{tag}|{str(spath)}\n"
              )

          PYEOF

      - name: Create GitHub Releases for new tags
        run: |
          set -euo pipefail

          if [ ! -f /tmp/new_tags.txt ]; then
            echo "No new tags to release."
            exit 0
          fi

          while IFS='|' read -r SKILL_NAME TAG SKILL_PATH; do
            echo "Creating release for $TAG ..."
            gh release create "$TAG" \
              --title "$TAG" \
              --generate-notes \
              "$SKILL_PATH"/SKILL.md \
              "$SKILL_PATH"/*.md \
              || echo "WARNING: release creation for $TAG had issues"
          done < /tmp/new_tags.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}